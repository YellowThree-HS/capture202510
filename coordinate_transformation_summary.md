# 点云坐标变换到机械臂基坐标系

## 🎯 功能概述

本代码实现了将相机坐标系中的点云转换到机械臂基坐标系的功能，包括：

1. **坐标变换计算**
2. **可视化对比**
3. **点云保存**
4. **物体中心计算**
5. **测试验证**

## 🔧 核心函数

### 1. `transform_points_to_robot_base()`
- **功能**: 将点云从相机坐标系转换到机械臂基坐标系
- **参数**: 
  - `points`: 点云坐标 (N, 3)
  - `robot_pose_matrix`: 机械臂末端位姿矩阵 (4x4)
  - `hand_eye_matrix`: 手眼标定矩阵 (4x4)
  - `cam_intrinsics`: 相机内参矩阵 (3x3)
- **返回**: 转换后的点云坐标

### 2. `visualize_coordinate_transformation()`
- **功能**: 可视化坐标变换前后的点云对比
- **特点**: 
  - 红色点云：相机坐标系
  - 绿色点云：机械臂基坐标系
  - 显示坐标系轴

### 3. `save_transformed_pointcloud()`
- **功能**: 保存转换后的点云到PLY文件
- **格式**: 支持颜色信息的点云文件

### 4. `calculate_object_center()`
- **功能**: 计算物体在机械臂基坐标系中的中心位置
- **返回**: [x, y, z] 坐标

## 📊 变换矩阵

### 手眼标定矩阵 (hand_eye_matrix)
```
[ 0.01230037,  0.99763761,  0.06758625,  0.08419052]
[-0.99992251,  0.01240196, -0.00108365,  0.00995925]
[-0.00191929, -0.06756769,  0.99771285, -0.15882536]
[ 0.0,         0.0,         0.0,         1.0        ]
```

### 机械臂位姿矩阵 (robot_matrix)
```
[-0.99058,  -0.016664,  -0.13595,  -0.48475 ]
[-0.013119,  0.99955,   -0.02693,   0.10345 ]
[ 0.13634,  -0.024892,  -0.99035,   0.33156 ]
[ 0,         0,          0,         1       ]
```

## 🔄 变换流程

1. **输入**: 相机坐标系中的点云
2. **变换**: `T_base = T_robot @ T_hand_eye`
3. **输出**: 机械臂基坐标系中的点云

## 🎨 可视化特性

- **双色对比**: 红色(相机) vs 绿色(基座)
- **坐标系显示**: 显示两个坐标系的方向
- **交互式查看**: 支持旋转、缩放、平移

## 📁 输出文件

- `transformed_pointcloud.ply`: 转换后的点云文件
- 控制台输出: 物体中心位置和变换信息

## 🧪 测试功能

- 内置测试函数验证坐标变换正确性
- 使用简单立方体点云进行测试
- 显示变换前后的中心点位置

## 🚀 使用方法

```python
# 运行完整程序（包括测试）
python lid_function.py

# 主要输出:
# 1. 变换矩阵信息
# 2. 坐标变换对比可视化
# 3. 物体中心位置
# 4. 保存的点云文件
```

## ⚙️ 技术细节

- **齐次坐标**: 使用4x4变换矩阵进行坐标变换
- **矩阵乘法**: `T_combined = T_robot @ T_hand_eye`
- **点云处理**: 支持大规模点云的批量变换
- **可视化**: 基于Open3D的3D可视化
- **深度比例**: RealSense D405 使用 `depth_scale=0.0001` (重要!)

## 🔧 重要修正

### 深度比例修正
- **问题**: 原始代码使用 `depth_scale=0.001`
- **修正**: 改为 `depth_scale=0.0001` (RealSense D405 的正确比例)
- **影响**: 显著改善距离测量的准确性
