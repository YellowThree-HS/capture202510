# ä½å§¿ä¼°è®¡åŸç†è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [æ€»ä½“æµç¨‹](#æ€»ä½“æµç¨‹)
2. [è¯¦ç»†æ­¥éª¤](#è¯¦ç»†æ­¥éª¤)
3. [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
4. [æ•°å­¦åŸç†](#æ•°å­¦åŸç†)
5. [ä»£ç å®ç°](#ä»£ç å®ç°)

---

## æ€»ä½“æµç¨‹

```
è¾“å…¥æ•°æ®
â”œâ”€ æ©ç  (mask)          : 480x640 çš„äºŒå€¼å›¾åƒ (0æˆ–1)
â”œâ”€ æ·±åº¦å›¾ (depth_image)  : 480x640 çš„æ·±åº¦å€¼ (å•ä½ï¼šç±³)
â”œâ”€ å½©è‰²å›¾ (color_image)  : 480x640x3 çš„RGBå›¾åƒ
â””â”€ ç›¸æœºå†…å‚ (intrinsics) : 3x3 çŸ©é˜µ

         â†“
         
æ­¥éª¤1: æ©ç æå– â†’ åªä¿ç•™ç‰©ä½“åŒºåŸŸ
æ­¥éª¤2: ç‚¹äº‘ç”Ÿæˆ â†’ 2Dåƒç´ è½¬3Dç‚¹
æ­¥éª¤3: å¹³é¢æ£€æµ‹ â†’ æ‰¾åˆ°ç‰©ä½“é¡¶é¢
æ­¥éª¤4: ç‰¹å¾æå– â†’ è®¡ç®—ä¸­å¿ƒå’Œæ³•å‘é‡
æ­¥éª¤5: ä½å§¿è®¡ç®— â†’ æ„å»ºåæ ‡ç³»

         â†“
         
è¾“å‡ºç»“æœ
â”œâ”€ pose : [x, y, z, roll, pitch, yaw]
â””â”€ T    : 4x4 å˜æ¢çŸ©é˜µ
```

---

## è¯¦ç»†æ­¥éª¤

### æ­¥éª¤1: æ©ç æå– ğŸ­

**ç›®çš„**: ä»å®Œæ•´å›¾åƒä¸­åˆ†ç¦»å‡ºç›®æ ‡ç‰©ä½“

**ä»£ç **:
```python
# 1. æ ¹æ®æ©ç æå–ç‚¹äº‘
color_masked = color_image * mask[:, :, np.newaxis]  # å½©è‰²å›¾åº”ç”¨æ©ç 
depth_masked = depth_image * mask                     # æ·±åº¦å›¾åº”ç”¨æ©ç 
```

**è¿‡ç¨‹è¯´æ˜**:
```
åŸå§‹å›¾åƒ (480x640)          æ©ç  (480x640)           ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¡Œå­ æ¯å­ å‹ºå­  â”‚    *    â”‚ 0  1  0         â”‚  =  â”‚     æ¯å­        â”‚
â”‚ èƒŒæ™¯ ç‰©ä½“ å…¶ä»–  â”‚         â”‚ 0  1  0         â”‚     â”‚     (è¢«ä¿ç•™)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ©ç å€¼:
  0 = èƒŒæ™¯ï¼Œä¼šè¢«è¿‡æ»¤æ‰
  1 = ç›®æ ‡ç‰©ä½“ï¼Œä¼šè¢«ä¿ç•™
```

**ç»“æœ**:
- `color_masked`: åªåŒ…å«ç‰©ä½“çš„å½©è‰²ä¿¡æ¯ï¼Œå…¶ä»–åŒºåŸŸä¸ºé»‘è‰²(0,0,0)
- `depth_masked`: åªåŒ…å«ç‰©ä½“çš„æ·±åº¦ä¿¡æ¯ï¼Œå…¶ä»–åŒºåŸŸä¸º0

---

### æ­¥éª¤2: ç‚¹äº‘ç”Ÿæˆ â˜ï¸

**ç›®çš„**: å°†2Då›¾åƒçš„åƒç´ è½¬æ¢ä¸º3Dç©ºé—´ä¸­çš„ç‚¹

**æ ¸å¿ƒå…¬å¼** (é’ˆå­”ç›¸æœºæ¨¡å‹):
```
å¯¹äºå›¾åƒä¸Šçš„æ¯ä¸ªåƒç´  (u, v) å’Œå¯¹åº”çš„æ·±åº¦å€¼ z:

x = (u - cx) * z / fx
y = (v - cy) * z / fy
z = z

å…¶ä¸­:
  fx, fy: ç„¦è·
  cx, cy: å…‰å¿ƒ
  (x, y, z): 3Dç©ºé—´åæ ‡
```

**ä»£ç å®ç°**:
```python
def create_point_cloud(depth_image, intrinsics, color_image):
    height, width = depth_image.shape[:2]
    u, v = np.meshgrid(np.arange(width), np.arange(height))
    
    # è¿‡æ»¤æ— æ•ˆæ·±åº¦å€¼
    valid_depth = depth_image.copy().astype(float)
    valid_depth[depth_image > 3.5] = 0  # å¤ªè¿œ
    valid_depth[depth_image < 0.1] = 0  # å¤ªè¿‘
    
    # è®¡ç®—3Dåæ ‡
    z = valid_depth
    x = (u - intrinsics[0][2]) * z / intrinsics[0][0]
    y = (v - intrinsics[1][2]) * z / intrinsics[1][1]
    
    # ç»„åˆç‚¹äº‘åæ ‡å’Œé¢œè‰²
    points = np.stack((x, y, z), axis=-1).reshape(-1, 3)
    colors = color_image[..., ::-1].reshape(-1, 3) / 255.0
    
    # åˆ›å»ºç‚¹äº‘å¯¹è±¡
    pcd = o3d.geometry.PointCloud()
    pcd.points = o3d.utility.Vector3dVector(points)
    pcd.colors = o3d.utility.Vector3dVector(colors)
    
    return pcd
```

**ç¤ºä¾‹**:
```
2Då›¾åƒåæ ‡              æ·±åº¦å€¼              3Dç‚¹äº‘åæ ‡
(u=320, v=240)    +    z=0.5ç±³    â†’     (x=0.0, y=0.0, z=0.5)
(u=400, v=240)    +    z=0.5ç±³    â†’     (x=0.065, y=0.0, z=0.5)
(u=320, v=300)    +    z=0.5ç±³    â†’     (x=0.0, y=0.049, z=0.5)
...
å¤§çº¦äº§ç”Ÿ 5000-20000 ä¸ª3Dç‚¹
```

**ç»“æœ**:
- ä¸€ä¸ªåŒ…å«æ•°åƒä¸ª3Dç‚¹çš„ç‚¹äº‘ï¼Œæ¯ä¸ªç‚¹æœ‰:
  - ä½ç½® (x, y, z)
  - é¢œè‰² (r, g, b)

---

### æ­¥éª¤3: å¹³é¢æ£€æµ‹ ğŸ“

**ç›®çš„**: æ‰¾åˆ°ç‰©ä½“çš„é¡¶é¢ï¼ˆå¯¹äºæ¯å­æ¥è¯´æ˜¯æ¯å£å¹³é¢ï¼‰

**ç®—æ³•**: RANSAC (éšæœºé‡‡æ ·ä¸€è‡´æ€§ç®—æ³•)

**åŸç†**:
```
1. éšæœºé€‰æ‹©3ä¸ªç‚¹
2. ç”¨è¿™3ä¸ªç‚¹æ‹Ÿåˆä¸€ä¸ªå¹³é¢
3. è®¡ç®—æ‰€æœ‰ç‚¹åˆ°è¿™ä¸ªå¹³é¢çš„è·ç¦»
4. ç»Ÿè®¡è·ç¦»å°äºé˜ˆå€¼çš„ç‚¹æ•°ï¼ˆå†…ç‚¹æ•°ï¼‰
5. é‡å¤1000æ¬¡
6. é€‰æ‹©å†…ç‚¹æ•°æœ€å¤šçš„å¹³é¢ä½œä¸ºæœ€ç»ˆç»“æœ
```

**å¹³é¢æ–¹ç¨‹**:
```
ax + by + cz + d = 0

å…¶ä¸­ (a, b, c) æ˜¯å¹³é¢æ³•å‘é‡
```

**ä»£ç **:
```python
def extract_cup_features(point_cloud):
    # 1. ä½¿ç”¨RANSACæ£€æµ‹å¹³é¢ï¼ˆæ¯å­é¡¶é¢ï¼‰
    plane_model, inliers = point_cloud.segment_plane(
        distance_threshold=0.005,  # 5mmå®¹å·®
        ransac_n=3,                # æ¯æ¬¡é‡‡æ ·3ä¸ªç‚¹
        num_iterations=1000        # è¿­ä»£1000æ¬¡
    )
    
    # plane_model = [a, b, c, d]
    # inliers = å±äºå¹³é¢çš„ç‚¹çš„ç´¢å¼•åˆ—è¡¨
```

**å¯è§†åŒ–**:
```
ç‚¹äº‘ä¾§è§†å›¾:

    æ¯å£é¡¶é¢ (æ£€æµ‹åˆ°çš„å¹³é¢)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    â•‘           â•‘
    â•‘           â•‘  æ¯å­ä¾§å£
    â•‘           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•
      æ¯å­åº•éƒ¨

å¹³é¢æ£€æµ‹ç»“æœ:
- å¹³é¢æ³•å‘é‡: (0.01, -0.02, 0.999) â† å‡ ä¹å‚ç›´å‘ä¸Š
- å†…ç‚¹æ•°: 1234 ä¸ªç‚¹
- å¹³é¢è·ç¦»åŸç‚¹: 0.567 ç±³
```

**æ£€æµ‹æ ‡å‡†**:
- âœ… å¥½çš„å¹³é¢: å†…ç‚¹æ•° > 100ï¼Œæ³•å‘é‡æ¥è¿‘ç«–ç›´
- âš ï¸ å·®çš„å¹³é¢: å†…ç‚¹æ•° < 50ï¼Œå¯èƒ½æ˜¯å™ªå£°
- âŒ å¤±è´¥: æ— æ³•æ‰¾åˆ°æ˜æ˜¾çš„å¹³é¢

---

### æ­¥éª¤4: ç‰¹å¾æå– ğŸ¯

**ç›®çš„**: ä»æ£€æµ‹åˆ°çš„å¹³é¢ä¸­æå–ç‰©ä½“çš„å…³é”®ä¿¡æ¯

**æå–çš„ç‰¹å¾**:

#### 4.1 ä¸­å¿ƒä½ç½®
```python
# 2. æå–é¡¶é¢ç‚¹äº‘
top_surface = point_cloud.select_by_index(inliers)
top_points = np.asarray(top_surface.points)

# 3. è®¡ç®—æ¯å­ä¸­å¿ƒï¼ˆé¡¶é¢ç‚¹äº‘çš„å‡ ä½•ä¸­å¿ƒï¼‰
center = np.mean(top_points, axis=0)
```

**ç¤ºä¾‹**:
```
é¡¶é¢ç‚¹äº‘ (ä¿¯è§†å›¾):

    Ã—  Ã—  Ã—  Ã—  Ã—
  Ã—              Ã—
  Ã—      âŠ•       Ã—  â† âŠ• æ˜¯å‡ ä½•ä¸­å¿ƒ
  Ã—              Ã—
    Ã—  Ã—  Ã—  Ã—  Ã—

è®¡ç®—: center = (Î£x/n, Î£y/n, Î£z/n)
ç»“æœ: center = (0.123, -0.045, 0.567) ç±³
```

#### 4.2 æ³•å‘é‡
```python
# 4. æå–æ³•å‘é‡ï¼ˆæŒ‡å‘ä¸Šæ–¹ï¼‰
normal = -plane_model[:3] / np.linalg.norm(plane_model[:3])

# ç¡®ä¿æ³•å‘é‡æŒ‡å‘ä¸Šæ–¹ï¼ˆzæ–¹å‘ä¸ºæ­£ï¼‰
if normal[2] < 0:
    normal = -normal
```

**æ³•å‘é‡è¯´æ˜**:
```
       â†‘ normal (0, 0, 1)
       â”‚
       â”‚
   â•â•â•â•â•â•â•â•â•â•â•
   â•‘       â•‘
   â•‘  æ¯å­  â•‘
   
æ³•å‘é‡æŒ‡å‘: å‚ç›´äºé¡¶é¢ï¼Œæœä¸Š
ç”¨é€”: ç¡®å®šç‰©ä½“çš„å§¿æ€ï¼ˆæ˜¯å¦å€¾æ–œï¼‰
```

#### 4.3 åŠå¾„ä¼°è®¡ï¼ˆå¯é€‰ï¼‰
```python
# 5. ä¼°è®¡æ¯å£åŠå¾„
distances = np.linalg.norm(top_points - center, axis=1)
radius = np.mean(distances)
```

**è¾“å‡º**:
```
ğŸ” æ¯å­ç‰¹å¾æå–:
   ä¸­å¿ƒä½ç½®: [0.123, -0.045, 0.567]  â† æ¯å­åœ¨ç©ºé—´ä¸­çš„ä½ç½®
   æ³•å‘é‡: [0.012, -0.034, 0.999]     â† å‡ ä¹ç«–ç›´ï¼ˆæ¯å­æœªå€¾æ–œï¼‰
   ä¼°è®¡åŠå¾„: 0.035m (3.5cm)           â† æ¯å£å¤§å°
```

---

### æ­¥éª¤5: ä½å§¿è®¡ç®— ğŸ§­

**ç›®çš„**: æ ¹æ®ä¸­å¿ƒå’Œæ³•å‘é‡æ„å»ºå®Œæ•´çš„6Dä½å§¿

**åæ ‡ç³»æ„å»º**:

ä½å§¿ = ä½ç½® + å§¿æ€

```
ä½ç½® (3ç»´): 
  - x, y, z: ç‰©ä½“ä¸­å¿ƒåœ¨ç©ºé—´ä¸­çš„åæ ‡

å§¿æ€ (3ç»´):
  - roll, pitch, yaw: ç‰©ä½“çš„æ—‹è½¬è§’åº¦
```

**å¦‚ä½•ç¡®å®šå§¿æ€ï¼Ÿ**

æˆ‘ä»¬éœ€è¦å»ºç«‹ç‰©ä½“è‡ªå·±çš„åæ ‡ç³»ï¼ˆX, Y, Zä¸‰ä¸ªè½´ï¼‰ï¼š

```python
def calculate_cup_pose(center, normal):
    # Zè½´ï¼šæ³•å‘é‡æ–¹å‘ï¼ˆæ¯å£æœå‘ï¼‰
    z_axis = normal / np.linalg.norm(normal)
    
    # Xè½´ï¼šé€‰æ‹©ä¸€ä¸ªä¸zè½´å‚ç›´çš„æ–¹å‘
    if abs(z_axis[2]) > 0.9:  # zè½´æ¥è¿‘ç«–ç›´
        x_axis = np.cross(z_axis, np.array([0, 1, 0]))
    else:
        x_axis = np.cross(z_axis, np.array([0, 0, 1]))
    x_axis = x_axis / np.linalg.norm(x_axis)
    
    # Yè½´ï¼šé€šè¿‡å‰ä¹˜å¾—åˆ°ï¼ˆç¡®ä¿å½¢æˆå³æ‰‹åæ ‡ç³»ï¼‰
    y_axis = np.cross(z_axis, x_axis)
    y_axis = y_axis / np.linalg.norm(y_axis)
    
    # æ„å»º4x4å˜æ¢çŸ©é˜µ
    T = np.eye(4)
    T[:3, 0] = x_axis  # ç¬¬ä¸€åˆ—ï¼šXè½´æ–¹å‘
    T[:3, 1] = y_axis  # ç¬¬äºŒåˆ—ï¼šYè½´æ–¹å‘
    T[:3, 2] = z_axis  # ç¬¬ä¸‰åˆ—ï¼šZè½´æ–¹å‘
    T[:3, 3] = center  # ç¬¬å››åˆ—ï¼šä½ç½®
    
    return T
```

**åæ ‡ç³»å¯è§†åŒ–**:
```
      Z (è“è‰²) â†‘  æ¯å£æœå‘
               â”‚
               â”‚
          â•â•â•â•â•â•â•â•â•â•â•â•â•
          â•‘         â•‘
    Y â†â”€â”€â”€â•‘    âŠ•    â•‘  â† âŠ• æ˜¯ç‰©ä½“ä¸­å¿ƒ
   (ç»¿è‰²) â•‘         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•
         ï¼
       X (çº¢è‰²) 

å³æ‰‹åæ ‡ç³»: X Ã— Y = Z
```

**å˜æ¢çŸ©é˜µç»“æ„**:
```
T = [ Xè½´x  Yè½´x  Zè½´x  ä¸­å¿ƒx ]
    [ Xè½´y  Yè½´y  Zè½´y  ä¸­å¿ƒy ]
    [ Xè½´z  Yè½´z  Zè½´z  ä¸­å¿ƒz ]
    [  0     0     0      1   ]

ä¾‹å¦‚:
T = [ 0.998  -0.052   0.012   0.123 ]
    [ 0.053   0.997  -0.034  -0.045 ]
    [-0.010   0.035   0.999   0.567 ]
    [ 0.000   0.000   0.000   1.000 ]
```

**è½¬æ¢ä¸ºæ¬§æ‹‰è§’**:
```python
def transform_matrix_to_pos_euler(T):
    # æå–ä½ç½®
    x, y, z = T[:3, 3]
    
    # æå–æ—‹è½¬çŸ©é˜µ
    rotation_matrix = T[:3, :3]
    
    # è½¬æ¢ä¸ºæ¬§æ‹‰è§’
    r = R.from_matrix(rotation_matrix)
    euler_angles = r.as_euler('xyz', degrees=True)
    
    return [x, y, z] + list(euler_angles)
```

**æœ€ç»ˆè¾“å‡º**:
```
âœ… æ¯å­ä½å§¿ä¼°è®¡æˆåŠŸ:
   ä½ç½®: [0.123, -0.045, 0.567]        â† (x, y, z) å•ä½ï¼šç±³
   å§¿æ€: [2.3Â°, -1.5Â°, 45.6Â°]          â† (roll, pitch, yaw) å•ä½ï¼šåº¦

è§£é‡Š:
- x = 0.123m  : ç‰©ä½“åœ¨ç›¸æœºå³ä¾§12.3cmå¤„
- y = -0.045m : ç‰©ä½“åœ¨ç›¸æœºä¸Šæ–¹4.5cmå¤„ï¼ˆyè½´å‘ä¸‹ä¸ºæ­£ï¼‰
- z = 0.567m  : ç‰©ä½“è·ç›¸æœº56.7cmè¿œ
- roll = 2.3Â° : ç»•Xè½´æ—‹è½¬2.3åº¦ï¼ˆå‡ ä¹ä¸å€¾æ–œï¼‰
- pitch = -1.5Â°: ç»•Yè½´æ—‹è½¬-1.5åº¦ï¼ˆå‡ ä¹ä¸å€¾æ–œï¼‰
- yaw = 45.6Â° : ç»•Zè½´æ—‹è½¬45.6åº¦ï¼ˆç›¸å¯¹äºå‚è€ƒæ–¹å‘ï¼‰
```

---

## æ ¸å¿ƒç®—æ³•

### 1. RANSAC å¹³é¢æ‹Ÿåˆ

**ä¼ªä»£ç **:
```python
æœ€ä½³å¹³é¢ = None
æœ€å¤šå†…ç‚¹æ•° = 0

for i in range(1000):
    # éšæœºé‡‡æ ·3ä¸ªç‚¹
    ç‚¹1, ç‚¹2, ç‚¹3 = éšæœºé€‰æ‹©3ä¸ªç‚¹()
    
    # æ‹Ÿåˆå¹³é¢
    å¹³é¢ = ç”¨3ç‚¹æ‹Ÿåˆå¹³é¢(ç‚¹1, ç‚¹2, ç‚¹3)
    
    # è®¡ç®—å†…ç‚¹æ•°
    å†…ç‚¹æ•° = 0
    for æ¯ä¸ªç‚¹ in æ‰€æœ‰ç‚¹:
        if ç‚¹åˆ°å¹³é¢çš„è·ç¦» < 0.005ç±³:
            å†…ç‚¹æ•° += 1
    
    # æ›´æ–°æœ€ä½³ç»“æœ
    if å†…ç‚¹æ•° > æœ€å¤šå†…ç‚¹æ•°:
        æœ€ä½³å¹³é¢ = å¹³é¢
        æœ€å¤šå†…ç‚¹æ•° = å†…ç‚¹æ•°

return æœ€ä½³å¹³é¢
```

**ä¼˜ç‚¹**:
- âœ… å¯¹å™ªå£°é²æ£’
- âœ… å¯¹å¼‚å¸¸ç‚¹ä¸æ•æ„Ÿ
- âœ… é€‚åˆå®æ—¶å¤„ç†

### 2. å‰ä¹˜æ„å»ºåæ ‡ç³»

**åŸç†**:
```
å·²çŸ¥: Zè½´æ–¹å‘ (æ³•å‘é‡)
ç›®æ ‡: æ‰¾åˆ°Xè½´å’ŒYè½´ï¼Œæ„æˆå³æ‰‹åæ ‡ç³»

æ­¥éª¤:
1. é€‰æ‹©ä¸€ä¸ªå‚è€ƒå‘é‡ ref (å¦‚ [0,1,0] æˆ– [0,0,1])
2. X = Z Ã— ref  (å‰ä¹˜å¾—åˆ°å‚ç›´äºZçš„å‘é‡)
3. Y = Z Ã— X    (å‰ä¹˜å¾—åˆ°åŒæ—¶å‚ç›´äºZå’ŒXçš„å‘é‡)
4. å½’ä¸€åŒ–æ‰€æœ‰å‘é‡

æ•°å­¦æ€§è´¨:
- X âŠ¥ Z
- Y âŠ¥ Z
- Y âŠ¥ X
- X Ã— Y = Z (å³æ‰‹æ³•åˆ™)
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**
- æ³•å‘é‡åªå‘Šè¯‰æˆ‘ä»¬"æœå‘"ï¼Œä¸è¶³ä»¥ç¡®å®šå®Œæ•´å§¿æ€
- éœ€è¦å»ºç«‹å®Œæ•´çš„3è½´åæ ‡ç³»
- å‰ä¹˜ä¿è¯äº†è½´ä¹‹é—´çš„æ­£äº¤æ€§

---

## æ•°å­¦åŸç†

### ç›¸æœºæŠ•å½±æ¨¡å‹

```
ä¸–ç•Œåæ ‡ â†’ ç›¸æœºåæ ‡ â†’ å›¾åƒåæ ‡

[ u ]   [ fx  0  cx ] [ x ]
[ v ] = [ 0  fy  cy ] [ y ]
[ 1 ]   [ 0   0   1 ] [ z ]

åå‘æŠ•å½±ï¼ˆæˆ‘ä»¬ä½¿ç”¨çš„ï¼‰:

x = (u - cx) * z / fx
y = (v - cy) * z / fy
z = z (æ·±åº¦å€¼)
```

### é½æ¬¡å˜æ¢çŸ©é˜µ

```
T = [ R  | t ]
    [----+---]
    [ 0  | 1 ]

å…¶ä¸­:
- R: 3x3 æ—‹è½¬çŸ©é˜µ
- t: 3x1 å¹³ç§»å‘é‡

åº”ç”¨å˜æ¢:
[x', y', z', 1]^T = T * [x, y, z, 1]^T
```

### æ—‹è½¬çŸ©é˜µ â†’ æ¬§æ‹‰è§’

```
å¯¹äºæ—‹è½¬çŸ©é˜µ R:

roll  = atan2(R[2,1], R[2,2])
pitch = atan2(-R[2,0], sqrt(R[2,1]^2 + R[2,2]^2))
yaw   = atan2(R[1,0], R[0,0])
```

---

## ä»£ç å®ç°

### å®Œæ•´è°ƒç”¨æµç¨‹

```python
# åœ¨ main.py ä¸­çš„è°ƒç”¨
pose, T = mask2pose(
    mask=result['mask'],              # FastSAMè¾“å‡ºçš„æ©ç 
    depth_image=depth_image_meters,   # D435æ·±åº¦å›¾ï¼ˆç±³ï¼‰
    color_image=color_image,          # D435å½©è‰²å›¾
    intrinsics=intr_matrix,           # ç›¸æœºå†…å‚
    T_cam2base=None                   # å¯é€‰ï¼šç›¸æœºåˆ°åŸºåº§å˜æ¢
)
```

### mask2pose å‡½æ•°æµç¨‹

```python
def mask2pose(mask, depth_image, color_image, intrinsics, T_cam2base=None):
    # æ­¥éª¤1: åº”ç”¨æ©ç 
    color_masked = color_image * mask[:, :, np.newaxis]
    depth_masked = depth_image * mask
    
    # æ­¥éª¤2: ç”Ÿæˆç‚¹äº‘
    point_cloud = create_point_cloud(depth_masked, intrinsics, color_masked)
    
    # æ­¥éª¤3: åæ ‡ç³»è½¬æ¢ï¼ˆå¯é€‰ï¼‰
    if T_cam2base is not None:
        point_cloud.transform(T_cam2base)
    
    # æ­¥éª¤4: æå–ç‰¹å¾
    center, normal, radius = extract_cup_features(point_cloud)
    
    # æ­¥éª¤5: è®¡ç®—ä½å§¿
    T = calculate_cup_pose(center, normal)
    
    # æ­¥éª¤6: è½¬æ¢ä¸ºæ¬§æ‹‰è§’
    pose = transform_matrix_to_pos_euler(T)
    
    return pose, T
```

---

## å…³é”®å‚æ•°

### RANSACå‚æ•°
```python
distance_threshold=0.005  # 5mm - ç‚¹åˆ°å¹³é¢çš„æœ€å¤§è·ç¦»
ransac_n=3                # 3ä¸ªç‚¹æ‹Ÿåˆå¹³é¢
num_iterations=1000       # è¿­ä»£æ¬¡æ•°
```

**è°ƒæ•´å»ºè®®**:
- ğŸ“ ç‰©ä½“è¾ƒå° â†’ å‡å° `distance_threshold` (å¦‚ 0.003)
- ğŸ“ ç‰©ä½“è¾ƒå¤§ â†’ å¢å¤§ `distance_threshold` (å¦‚ 0.008)
- ğŸ² å™ªå£°å¤š â†’ å¢åŠ  `num_iterations` (å¦‚ 2000)

### æ·±åº¦è¿‡æ»¤
```python
valid_depth[depth_image > 3.5] = 0  # å¤ªè¿œ
valid_depth[depth_image < 0.1] = 0  # å¤ªè¿‘
```

**D435å·¥ä½œèŒƒå›´**:
- æœ€å°è·ç¦»: 0.1ç±³
- æœ€å¤§è·ç¦»: 3.5ç±³
- æœ€ä½³è·ç¦»: 0.3-2ç±³

---

## è¯¯å·®æ¥æºä¸ä¼˜åŒ–

### 1. æ·±åº¦å™ªå£°
**æ¥æº**: D435ä¼ æ„Ÿå™¨ç²¾åº¦é™åˆ¶  
**å½±å“**: ç‚¹äº‘æŠ–åŠ¨ï¼Œå¹³é¢ä¸ç¨³å®š  
**ä¼˜åŒ–**: 
- å¢åŠ RANSACè¿­ä»£æ¬¡æ•°
- ä½¿ç”¨æ—¶é—´å¹³æ»‘ï¼ˆå¤šå¸§å¹³å‡ï¼‰

### 2. æ©ç ä¸å‡†ç¡®
**æ¥æº**: FastSAMåˆ†å‰²è¯¯å·®  
**å½±å“**: åŒ…å«èƒŒæ™¯ç‚¹ï¼Œå¹³é¢æ£€æµ‹å¤±è´¥  
**ä¼˜åŒ–**:
- æé«˜åˆ†å‰²ç½®ä¿¡åº¦é˜ˆå€¼
- å½¢æ€å­¦æ“ä½œï¼ˆè…èš€/è†¨èƒ€ï¼‰

### 3. åå…‰è¡¨é¢
**æ¥æº**: ç‰©ä½“è¡¨é¢åå…‰  
**å½±å“**: æ·±åº¦å€¼æ— æ•ˆ  
**ä¼˜åŒ–**:
- è°ƒæ•´ç›¸æœºæ›å…‰
- å¢åŠ ç¯å¢ƒå…‰

### 4. è¾¹ç¼˜æ•ˆåº”
**æ¥æº**: ç‰©ä½“è¾¹ç¼˜æ·±åº¦ä¸è¿ç»­  
**å½±å“**: è¾¹ç¼˜ç‚¹äº‘ä¸å‡†ç¡®  
**ä¼˜åŒ–**:
- å¯¹æ©ç è¿›è¡Œè…èš€
- åªä½¿ç”¨ä¸­å¿ƒåŒºåŸŸçš„ç‚¹

---

## å…¸å‹ç»“æœç¤ºä¾‹

### ç¤ºä¾‹1: ç†æƒ³æƒ…å†µ
```
è¾“å…¥:
- ç‰©ä½“: ç™½è‰²é™¶ç“·æ¯
- è·ç¦»: 0.5ç±³
- å…‰ç…§: å……è¶³
- å§¿æ€: ç«–ç›´æ‘†æ”¾

è¾“å‡º:
âœ… æ¯å­ä½å§¿ä¼°è®¡æˆåŠŸ:
   ä¸­å¿ƒä½ç½®: [0.000, 0.000, 0.500]
   æ³•å‘é‡: [0.000, 0.000, 1.000]
   ä¼°è®¡åŠå¾„: 0.040m (4.0cm)
   ä½ç½®: [0.000, 0.000, 0.500] ç±³
   å§¿æ€: [0.0Â°, 0.0Â°, 0.0Â°]

ç‚¹äº‘è´¨é‡: â˜…â˜…â˜…â˜…â˜…
å¹³é¢å†…ç‚¹: 1500+ ä¸ª
ç½®ä¿¡åº¦: éå¸¸é«˜
```

### ç¤ºä¾‹2: å€¾æ–œæƒ…å†µ
```
è¾“å…¥:
- ç‰©ä½“: ä¸é”ˆé’¢æ¯
- è·ç¦»: 0.8ç±³
- å§¿æ€: å€¾æ–œçº¦15åº¦

è¾“å‡º:
âœ… æ¯å­ä½å§¿ä¼°è®¡æˆåŠŸ:
   ä¸­å¿ƒä½ç½®: [0.120, -0.080, 0.790]
   æ³•å‘é‡: [0.259, 0.000, 0.966]  â† æœ‰æ˜æ˜¾å€¾æ–œ
   ä¼°è®¡åŠå¾„: 0.035m (3.5cm)
   ä½ç½®: [0.120, -0.080, 0.790] ç±³
   å§¿æ€: [15.2Â°, 0.1Â°, 5.3Â°]     â† pitchçº¦15åº¦

ç‚¹äº‘è´¨é‡: â˜…â˜…â˜…â˜…â˜†
å¹³é¢å†…ç‚¹: 800+ ä¸ª
ç½®ä¿¡åº¦: é«˜
```

### ç¤ºä¾‹3: å›°éš¾æƒ…å†µ
```
è¾“å…¥:
- ç‰©ä½“: é»‘è‰²å¡‘æ–™æ¯
- è·ç¦»: 1.5ç±³
- å…‰ç…§: è¾ƒæš—
- è¡¨é¢: åå…‰

è¾“å‡º:
âš ï¸ æ£€æµ‹åˆ°çš„å¹³é¢ç‚¹è¾ƒå°‘
âœ… æ¯å­ä½å§¿ä¼°è®¡æˆåŠŸ:
   ä¸­å¿ƒä½ç½®: [0.050, 0.030, 1.520]
   æ³•å‘é‡: [0.035, -0.042, 0.998]
   ä¼°è®¡åŠå¾„: 0.038m (3.8cm)
   ä½ç½®: [0.050, 0.030, 1.520] ç±³
   å§¿æ€: [2.8Â°, -3.2Â°, 12.5Â°]

ç‚¹äº‘è´¨é‡: â˜…â˜…â˜†â˜†â˜†
å¹³é¢å†…ç‚¹: 150 ä¸ª  â† è¾ƒå°‘
ç½®ä¿¡åº¦: ä¸­ç­‰
å»ºè®®: æ”¹å–„å…‰ç…§ï¼Œç§»è¿‘ç›¸æœº
```

---

## æ€»ç»“

### å…³é”®æ­¥éª¤å›é¡¾
1. **æ©ç æå–**: åˆ†ç¦»ç›®æ ‡ç‰©ä½“
2. **ç‚¹äº‘ç”Ÿæˆ**: 2D â†’ 3D è½¬æ¢
3. **å¹³é¢æ£€æµ‹**: RANSACæ‰¾é¡¶é¢
4. **ç‰¹å¾æå–**: è®¡ç®—ä¸­å¿ƒå’Œæ³•å‘é‡
5. **ä½å§¿è®¡ç®—**: æ„å»ºåæ ‡ç³»

### æ ¸å¿ƒæŠ€æœ¯
- âœ… é’ˆå­”ç›¸æœºæ¨¡å‹
- âœ… RANSACé²æ£’ä¼°è®¡
- âœ… å‘é‡å‰ä¹˜
- âœ… é½æ¬¡å˜æ¢çŸ©é˜µ

### é€‚ç”¨ç‰©ä½“
- âœ… æ¯å­ã€ç¢—ï¼ˆåœ†å½¢é¡¶é¢ï¼‰
- âœ… ç›’å­ã€ä¹¦ï¼ˆå¹³é¢é¡¶éƒ¨ï¼‰
- âœ… ç“¶å­ï¼ˆåœ†å½¢é¡¶éƒ¨ï¼‰
- âš ï¸ å‹ºå­ï¼ˆéœ€è¦æ”¹è¿›ï¼Œé¡¶é¢ä¸æ˜æ˜¾ï¼‰
- âŒ çƒä½“ï¼ˆæ— æ˜æ˜¾å¹³é¢ï¼‰

---

**æƒ³äº†è§£æ›´å¤šï¼Ÿ** æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–æé—®ï¼
