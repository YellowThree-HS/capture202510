# 多实例检测功能说明

## 功能概述

系统现在支持对特定类别（如 bowl）检测多个实例，同时对其他类别（如 cup、spoon）保持单实例检测策略。

## 配置说明

### 检测类别

在 `main.py` 中配置：

```python
# 检测类别列表
categories_to_find = ["cup", "spoon", "bowl"]

# Bowl 的特殊配置：保留多个实例
multi_instance_classes = ["bowl"]  # 允许检测多个碗
bowl_conf_threshold = 0.30         # 碗的置信度阈值（30%）
bowl_max_count = 3                 # 最多检测3个碗
```

### 检测策略

| 类别 | 策略 | 说明 |
|------|------|------|
| cup | 单实例 | 只保留置信度最高的一个杯子 |
| spoon | 单实例 | 只保留置信度最高的一个勺子 |
| bowl | 多实例 | 保留最多3个碗（置信度>30%） |

## 工作原理

### 1. 检测阶段

YOLO-World 检测所有物体，返回所有检测框和置信度。

### 2. 筛选阶段

**单实例类别（cup, spoon）：**
- 对每个类别，只保留置信度最高的一个检测结果
- 忽略同类别的其他检测

**多实例类别（bowl）：**
- 筛选出所有置信度 >= 30% 的检测结果
- 按置信度降序排序
- 保留前3个（或更少，如果检测数量不足）

### 3. 分割阶段

对筛选后的所有物体执行 FastSAM 分割，生成精确的掩码。

### 4. 位姿估计阶段

为每个物体计算 6DoF 位姿。

## 输出示例

```
Found 8 objects, filtering...
  cup: 1 instance (best)
  spoon: 1 instance (best)
  bowl: 3 instances (from 5 detected, conf>=0.3)

Total objects to segment: 5

Starting segmentation...
  Segmented: cup (conf=0.85)
  Segmented: spoon (conf=0.78)
  Segmented: bowl (conf=0.65)
  Segmented: bowl (conf=0.52)
  Segmented: bowl (conf=0.35)

Total objects processed: 5

============================================================
开始位姿估计...
============================================================

🔍 物体 1/5: cup
   置信度: 0.85
   📍 位置: [0.123, -0.045, 0.512] 米
   📐 姿态: [1.2°, -0.5°, 0.3°]

🔍 物体 2/5: spoon
   置信度: 0.78
   📍 位置: [-0.003, 0.007, 0.359] 米
   📐 姿态: [139.2°, -35.0°, -23.2°]
   🥄 勺头中心位置: [-0.031, -0.017, 0.382] 米
   🥄 勺柄姿态: [roll=0.0°, pitch=-22.8°, yaw=-21.8°]

🔍 物体 3/5: bowl
   置信度: 0.65
   📍 位置: [0.234, 0.112, 0.489] 米
   📐 姿态: [2.1°, -1.2°, 15.3°]

🔍 物体 4/5: bowl
   置信度: 0.52
   📍 位置: [-0.145, 0.089, 0.502] 米
   📐 姿态: [3.5°, 0.8°, -8.7°]

🔍 物体 5/5: bowl
   置信度: 0.35
   📍 位置: [0.089, -0.178, 0.475] 米
   📐 姿态: [1.8°, -2.1°, 22.4°]

============================================================
✅ 成功估计了 5 个物体的位姿
============================================================

📊 位姿汇总:

  1. cup (置信度: 0.85)
     位置: [0.123, -0.045, 0.512] 米
     姿态: [1.2°, -0.5°, 0.3°]

  2. spoon (置信度: 0.78)
     位置: [-0.003, 0.007, 0.359] 米
     姿态: [139.2°, -35.0°, -23.2°]
     勺头中心位置: [-0.031, -0.017, 0.382] 米
     勺柄姿态: [roll=0.0°, pitch=-22.8°, yaw=-21.8°]

  3. bowl (置信度: 0.65)
     位置: [0.234, 0.112, 0.489] 米
     姿态: [2.1°, -1.2°, 15.3°]

  4. bowl (置信度: 0.52)
     位置: [-0.145, 0.089, 0.502] 米
     姿态: [3.5°, 0.8°, -8.7°]

  5. bowl (置信度: 0.35)
     位置: [0.089, -0.178, 0.475] 米
     姿态: [1.8°, -2.1°, 22.4°]
```

## 参数调整

### 修改 bowl 的置信度阈值

在 `main.py` 中修改：

```python
bowl_conf_threshold = 0.40  # 改为 40%
```

### 修改 bowl 的最大数量

```python
bowl_max_count = 5  # 最多检测 5 个碗
```

### 添加其他多实例类别

例如，也想检测多个杯子：

```python
multi_instance_classes = ["bowl", "cup"]  # 添加 cup
bowl_conf_threshold = 0.30  # 适用于所有多实例类别
bowl_max_count = 3
```

## API 参数说明

`detect_and_segment_all()` 函数的多实例参数：

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `multi_instance_classes` | list | `None` | 允许多实例的类别列表 |
| `multi_conf_threshold` | float | `0.3` | 多实例类别的最低置信度 |
| `multi_max_count` | int | `3` | 每个多实例类别的最大数量 |

## 应用场景

### 1. 餐具整理
- 检测多个碗，规划批量抓取顺序
- 单个杯子和勺子的精确定位

### 2. 物品清点
- 统计桌面上碗的数量
- 记录每个碗的位置

### 3. 场景理解
- 识别多个相同物体的空间分布
- 支持更复杂的任务规划

## 注意事项

1. **置信度阈值**：
   - 设置太低（如 0.1）：会有误检
   - 设置太高（如 0.8）：可能漏检
   - 建议值：0.3-0.5

2. **最大数量**：
   - 影响处理时间（分割和位姿估计）
   - 建议根据实际场景设置（通常 3-5 个）

3. **检测遮挡**：
   - 如果碗之间有遮挡，可能检测不全
   - 置信度会受到遮挡程度影响

4. **处理时间**：
   - 检测物体越多，处理时间越长
   - 每个物体需要分割和位姿估计（约 0.1-0.3 秒）

## 扩展性

可以轻松扩展到其他类别：

```python
# 检测多个盘子和多个碗
categories_to_find = ["cup", "spoon", "bowl", "plate"]
multi_instance_classes = ["bowl", "plate"]
multi_conf_threshold = 0.30
multi_max_count = 3
```

## 相关文件

- `lib/yolo_and_sam.py`: 检测和分割实现
- `main.py`: 主程序和配置
- `lib/mask2pose.py`: 位姿估计
- `readme.md`: 项目总体说明

