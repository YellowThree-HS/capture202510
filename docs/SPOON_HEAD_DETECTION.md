# 勺子圆头中心检测功能

## 功能概述

本系统已增强勺子检测功能，除了检测勺子的整体位姿外，现在还能：
1. **精确识别勺头圆形部分的中心位置**
2. **计算勺柄的姿态（方向角度）**

## 工作原理

### 1. 主轴检测（PCA方法）
首先使用PCA（主成分分析）方法：
- 分析勺子点云的主要方向
- 主轴（第一主成分）指向勺子的细长方向
- 通过几何宽度分析确保主轴指向勺头（较宽的一端）

### 2. 勺头区域提取
识别勺头中心的步骤：
1. **沿主轴分段**：将点云沿主轴投影
2. **定位前端**：找到主轴方向的最前端（勺头端）
3. **提取勺头区域**：取主轴前25%的点云作为勺头区域
4. **计算中心**：计算勺头区域点云的质心，即为勺头中心
5. **估计半径**：在垂直于主轴的平面上计算点到中心的平均距离

### 3. 技术细节

```python
# 核心函数
def extract_spoon_head_center(point_cloud, main_axis, centroid, head_ratio=0.25):
    """
    参数:
        point_cloud: 勺子的点云数据
        main_axis: 主轴方向（已经指向勺头）
        centroid: 点云质心
        head_ratio: 勺头占整体长度的比例（默认0.25）
    
    返回:
        head_center: 勺头圆形中心位置 (x, y, z)
        head_radius: 勺头半径估计
    """
```

## 使用方法

### 运行程序

```bash
python main.py
```

### 操作步骤

1. **启动相机**：程序启动后会自动打开D435相机实时预览
2. **触发检测**：按**空格键**进行检测和位姿估计
3. **查看结果**：检测到勺子时，会自动显示：
   - 勺子整体位姿（位置 + 姿态）
   - 勺头中心坐标
   - 勺头半径估计
4. **3D可视化**：按**v键**打开3D可视化窗口，可以看到：
   - 完整的场景点云
   - 勺子坐标系（显示位姿）
   - **橙色球体**：标记勺头中心
   - **小坐标系**：勺头中心位置

## 输出示例

检测到勺子时，控制台会显示类似以下信息：

```
🔍 物体 1/2: spoon
   置信度: 0.85
   边界框: [245, 180, 412, 356]

📏 检测到细长物体 'spoon'，使用PCA主轴法

🔍 细长物体特征提取 (PCA):
   质心位置: [0.245, -0.123, 0.456] (用于PCA)
   中心位置: [0.252, -0.119, 0.461] (主轴几何中点，抓取点)
   主轴方向: [0.856, -0.342, 0.387]
   估计长度: 0.158m (15.8cm)
   特征值比率: 8.52 (主/次), 12.34 (主/第三)
   ✓ 主轴方向保持，已指向更宽的一端（勺头）

🥄 勺子特征提取:
   勺头中心: [0.291, -0.098, 0.478]
   勺头半径: 0.025m (2.5cm)
   勺头点数: 347 / 1523 (22.8%)
   勺柄方向: [0.856, -0.342, 0.387]
   勺柄姿态: [roll=0.0°, pitch=-22.8°, yaw=-21.8°]

✅ spoon位姿估计成功:
   位置: [0.252, -0.119, 0.461]
   姿态: [12.3°, -5.7°, 45.2°]
   位姿估计耗时: 0.12s
   
   📍 位置 (x, y, z): [0.252, -0.119, 0.461] 米
   📐 姿态 (roll, pitch, yaw): [12.3°, -5.7°, 45.2°]
   🥄 勺头中心位置: [0.291, -0.098, 0.478] 米
   🥄 勺头半径: 0.025m (2.5cm)
   🥄 勺柄姿态: [roll=0.0°, pitch=-22.8°, yaw=-21.8°]
```

## 位姿汇总

程序会在最后打印汇总信息：

```
📊 位姿汇总:

  1. cup (置信度: 0.92)
     位置: [0.123, -0.045, 0.512] 米
     姿态: [1.2°, -0.5°, 0.3°]

  2. spoon (置信度: 0.85)
     位置: [0.252, -0.119, 0.461] 米
     姿态: [12.3°, -5.7°, 45.2°]
     勺头中心位置: [0.291, -0.098, 0.478] 米
     勺头半径: 2.5cm
     勺柄姿态: [roll=0.0°, pitch=-22.8°, yaw=-21.8°]
```

## 3D可视化说明

按 **v键** 后打开的3D可视化窗口中：

- **白色点云**：完整的场景
- **彩色坐标系**：每个物体的位姿
  - X轴（红色）
  - Y轴（绿色）- 勺柄方向
  - Z轴（蓝色）
- **橙色球体**：勺头中心位置标记（仅勺子）

## 应用场景

勺头中心检测可用于：

1. **精确抓取**：机器人可以针对勺头进行精确抓取
2. **姿态控制**：根据勺头位置调整抓取姿态
3. **舀取操作**：确定舀取食物的最佳位置
4. **避障规划**：计算勺头与周围物体的距离

## 技术参数

- **勺头区域比例**：默认为整体长度的25%（`head_ratio=0.25`）
- **最小点数要求**：勺头区域至少需要10个点
- **半径计算**：基于点到中心在垂直主轴平面上的投影距离

## 自定义调整

如需调整勺头检测的参数，可以修改 `lib/mask2pose.py` 中的调用：

```python
head_center, head_radius = extract_spoon_head_center(
    point_cloud, 
    main_axis, 
    centroid, 
    head_ratio=0.25  # 修改此参数来调整勺头区域大小
)
```

## 注意事项

1. **勺头比例**：默认提取前25%作为勺头，适合大多数普通勺子。对于特殊形状的勺子可能需要调整
2. **点云密度**：需要足够的点云数据才能准确估计勺头中心
3. **遮挡情况**：如果勺头被遮挡，可能影响检测精度
4. **方向判断**：系统会自动确保主轴指向勺头（较宽端），但极端情况下可能需要人工验证

## 相关文件

- `lib/mask2pose.py`：核心算法实现
  - `extract_spoon_head_center()`: 勺头中心提取
  - `extract_elongated_features()`: PCA主轴分析
- `main.py`：主程序，集成勺头检测功能
- `docs/TABLE_ASSISTED_POSE.md`：整体位姿估计文档

## 未来改进方向

1. **圆形拟合**：使用RANSAC进行更精确的圆形拟合
2. **自适应比例**：根据勺子形状自动调整勺头区域比例
3. **多种勺型支持**：支持汤勺、茶勺、长柄勺等不同类型
4. **勺口方向**：检测勺口的开口方向（上/下）

