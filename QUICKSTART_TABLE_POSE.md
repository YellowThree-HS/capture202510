# 🚀 快速开始：桌面辅助的杯子位姿检测

## 📋 新功能简介

这个更新添加了一个更鲁棒的杯子位姿检测方法，利用桌面信息来提高精度。

### **与原方法对比**

| 特性 | 原方法 | 新方法（桌面辅助） |
|------|--------|------------------|
| 检测目标 | 杯口平面 | 桌面平面 ✅ |
| 参考点位置 | 杯口中心 | 杯子底部（贴桌面）✅ |
| 遮挡鲁棒性 | 低 | 高 ✅ |
| 高度信息 | ❌ | ✅ |
| 适用场景 | 杯口完全可见 | 杯口可部分遮挡 ✅ |

## 🎯 快速测试

### **步骤1: 运行程序**

```bash
python main.py
```

### **步骤2: 放置杯子**

在桌子上放置一个杯子（杯口朝上），确保：
- ✅ 杯子放在平面桌子上
- ✅ 杯子周围有可见的桌面区域
- ✅ 相机能看到杯子

### **步骤3: 触发检测**

按 **空格键** 触发检测

### **步骤4: 查看结果**

你会看到类似这样的输出：

```
============================================================
🔲 使用桌面辅助的位姿估计方法 (物体: cup)
============================================================

🔍 开始检测桌面...
✅ 桌面检测成功:
   桌面高度: 0.450m
   桌面法向量: [0.001, 0.002, 0.999]
   桌面点数: 1234

🔍 杯子位姿计算（基于桌面）:
   底部中心: [0.123, 0.456, 0.450]
   杯子高度: 0.105m (10.5cm)
   杯子顶部Z: 0.555m
   桌面高度: 0.450m

✅ cup位姿估计成功 (桌面辅助法):
   底部位置: [0.123, 0.456, 0.450]
   姿态: [0.5°, -1.2°, 45.3°]
   杯子高度: 0.105m (10.5cm)
```

### **步骤5: 3D可视化（可选）**

按 **v 键** 打开 3D 可视化窗口，查看：
- 白色点云：场景
- 坐标系：杯子底部中心位置
  - 红色轴：X轴
  - 绿色轴：Y轴
  - 蓝色轴：Z轴（向上）

## 📊 输出数据解释

### **位姿信息 (pose)**

```python
pose = [x, y, z, roll, pitch, yaw]

# x, y, z: 杯子底部中心在基坐标系中的位置（米）
#   - x, y: 水平位置
#   - z: 桌面高度（杯子底部）

# roll, pitch, yaw: 杯子的姿态角（度）
#   - roll: 绕X轴旋转
#   - pitch: 绕Y轴旋转
#   - yaw: 绕Z轴旋转
```

### **额外信息 (extra_info)**

```python
extra_info = {
    'height': 0.105,          # 杯子高度（米）
    'table_height': 0.450,    # 桌面高度（米）
    'bottom_center': [x, y, z],  # 底部中心坐标
    'method': 'table_assisted'   # 使用的方法
}
```

## 🎨 应用场景

### **场景1: 机器人抓取**

```python
# 获取杯子位姿
pose, T, extra_info = mask2pose_with_table(...)

# 底部中心位置（适合抓取规划）
x, y, z = pose[:3]
cup_height = extra_info['height']

# 计算抓取点（例如：杯子中部）
grasp_z = z + cup_height / 2
grasp_pose = [x, y, grasp_z, roll, pitch, yaw]
```

### **场景2: 碰撞检测**

```python
# 知道杯子高度，可以进行碰撞检测
table_height = extra_info['table_height']
cup_top = table_height + extra_info['height']

# 确保机械臂末端不会碰撞
if robot_z < cup_top + safety_margin:
    print("警告：可能发生碰撞")
```

## ⚠️ 常见问题

### **Q1: 桌面检测失败？**

**可能原因：**
- 检测框太小，不包含足够的桌面区域
- 桌面不是平面（布料、不规则表面）
- 杯子悬空或手持

**解决方案：**
- 系统会自动回退到原始方法
- 检查输出日志，查看错误原因

### **Q2: 杯子高度不准确？**

**可能原因：**
- 杯子底部离桌面有间隙
- 深度图质量差

**解决方案：**
- 确保杯子平稳放置
- 改善光照条件
- 检查相机位置和角度

### **Q3: 位置偏移？**

**可能原因：**
- 相机内参不准确
- 需要手眼标定（T_cam2base）

**解决方案：**
- 运行相机标定
- 进行手眼标定，设置正确的 T_cam2base

## 🔧 调试技巧

### **1. 检查点云质量**

```python
# 在 mask2pose_with_table 中添加可视化
import open3d as o3d

# 可视化bbox点云（应该包含杯子+桌面）
o3d.visualization.draw_geometries([bbox_point_cloud])

# 可视化mask点云（应该只有杯子）
o3d.visualization.draw_geometries([mask_point_cloud])
```

### **2. 查看检测框**

检测结果图会保存在 `result/det_*.jpg`，检查：
- 检测框是否包含杯子
- 检测框周围是否有足够的桌面区域

### **3. 启用详细日志**

代码已包含详细的调试输出，查看终端信息：
- 桌面高度
- 杯子高度
- 点云数量
- 检测状态

## 💡 最佳实践

1. **相机位置**
   - 相机应该俯视桌面（45-90度角）
   - 确保能看到杯子和周围桌面

2. **场景设置**
   - 使用平坦的桌面
   - 避免杂乱的背景
   - 良好的光照条件

3. **杯子摆放**
   - 杯口朝上
   - 平稳放置在桌面上
   - 周围留有一定空间

4. **参数调整**
   - 如果桌面检测不稳定，可以调整 `distance_threshold`（在 `detect_table_from_bbox` 函数中）
   - 默认值：0.008（8mm容差）

## 📚 进一步阅读

- 📖 [详细技术文档](docs/TABLE_ASSISTED_POSE.md)
- 📖 [相机使用说明](docs/CAMERA_USAGE.md)
- 📖 [位姿估计原理](docs/POSE_ESTIMATION_EXPLAINED.md)

## 🆘 获取帮助

如果遇到问题：
1. 查看终端输出的错误信息
2. 检查 `result/` 目录中的检测结果图
3. 尝试在不同光照/角度下测试
4. 参考详细文档

---

**最后更新**: 2025-10-11  
**版本**: 1.0

